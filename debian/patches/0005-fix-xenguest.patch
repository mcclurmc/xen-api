From: Jon Ludlam <jonathan.ludlam@eu.citrix.com>
Date: Fri, 7 Oct 2011 14:44:36 +0100
Subject: fix-xenguest

---
 ocaml/xenguest/OMakefile        |    2 +-
 ocaml/xenguest/xenguest_stubs.c |   24 +++++++++++-------------
 2 files changed, 12 insertions(+), 14 deletions(-)

--- a/ocaml/xenguest/OMakefile
+++ b/ocaml/xenguest/OMakefile
@@ -2,7 +2,7 @@
 OCAML_LIBS =
 OCAMLINCLUDES =
 OCAML_CLIBS = xenguest_stubs
-OCAML_LINK_FLAGS += $(XEN_OCAML_LINK_FLAGS) -cclib -L$(XEN_ROOT)/usr/$(LIBDIR) -cclib -lz -cclib -lxenguest -cclib -lxenctrl -cclib -lxenstore
+OCAML_LINK_FLAGS += -linkpkg -cclib -lz -cclib -lxenguest -cclib -lxenctrl -cclib -lxenstore
 OCAMLPACKS = unix stdext
 
 XENGUEST_SRC_FILES = dumpcore.ml xenguest.ml xenguest_main.ml xenguest_stubs.c
--- a/ocaml/xenguest/xenguest_stubs.c
+++ b/ocaml/xenguest/xenguest_stubs.c
@@ -39,10 +39,6 @@
 
 #define None_val (Val_int(0))
 
-#ifndef HVM_PARAM_NX_ENABLED
-#define XEN_UNSTABLE
-#endif 
-
 #ifndef HVM_PARAM_VIRIDIAN
 #warning missing viridian parameter
 #endif
@@ -329,11 +325,8 @@
 	                       c_console_evtchn, &console_mfn);
 	caml_leave_blocking_section();
 
-#ifndef XEN_UNSTABLE
-	strncpy(c_protocol, xc_dom_get_native_protocol(dom), 64);
-#else
 	memset(c_protocol, '\0', 64);
-#endif
+
 	free(c_image_name);
 	free(c_ramdisk_name);
 	xc_dom_release(dom);
@@ -393,15 +386,20 @@
 
 	xc_get_hvm_param(xch, domid, HVM_PARAM_STORE_PFN, store_mfn);
 	xc_set_hvm_param(xch, domid, HVM_PARAM_PAE_ENABLED, f.pae);
+
 #ifdef HVM_PARAM_VIRIDIAN
 	xc_set_hvm_param(xch, domid, HVM_PARAM_VIRIDIAN, f.viridian);
 #endif
+
 	xc_set_hvm_param(xch, domid, HVM_PARAM_STORE_EVTCHN, store_evtchn);
-#ifndef XEN_UNSTABLE
+
+#ifdef HVM_PARAM_NX_ENABLED
 	xc_set_hvm_param(xch, domid, HVM_PARAM_NX_ENABLED, f.nx);
-  xc_get_hvm_param(xch, domid, HVM_PARAM_CONSOLE_PFN, console_mfn);
-  xc_set_hvm_param(xch, domid, HVM_PARAM_CONSOLE_EVTCHN, console_evtchn);
 #endif
+
+	xc_get_hvm_param(xch, domid, HVM_PARAM_CONSOLE_PFN, console_mfn);
+	xc_set_hvm_param(xch, domid, HVM_PARAM_CONSOLE_EVTCHN, console_evtchn);
+
 	return 0;
 }
 
